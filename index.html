<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todos/Goals</title>
</head>
<body>
    <section>
        <h1>Todo List</h1>
        <input id="todo" type="text" placeholder="Add Todo" />
        <button id="todoBtn">Add Todo</button>
        <ul id="todos"></ul>
    </section>
    <section>
        <h1>Goals</h1>
        <input id="goal" type="text" placeholder="Add Goal" />
        <button id="goalBtn">Add Goal</button>
        <ul id="goals"></ul>
    </section>
    <script type="text/javascript">
        // Library code
        const createStore = (reducer) => {
            /**
             * The store should have four parts
             * 1. The state
             * 2. Get the state. (getState)
             * 3. Listen to changes on the state. (subscribe)
             * 4. Update the state. (dispatch)
             */

            let state
            let listeners = []
            
            const getState = () => state
            
            const subscribe = (listener) => {
                listeners.push(listener)
                return () => {
                    listeners = listeners.filter(l => l !== listener)
                }
            }
            
            const dispatch = (action) => {
                state = reducer(state, action)
                listeners.forEach(listener => listener())
            }
            
            return {
                getState,
                subscribe,
                dispatch,
            }
        }

        // App code
        const ADD_TODO = "ADD_TODO"
        const REMOVE_TODO = "REMOVE_TODO"
        const TOGGLE_TODO = "TOGGLE_TODO"
        const ADD_GOAL = "ADD_GOAL"
        const REMOVE_GOAL = "REMOVE_GOAL"

        const addTodoAction = (todo) => {
            return {
                type: ADD_TODO,
                todo,
            }
        }

        const removeTodoAction = (id) => {
            return {
                type: REMOVE_TODO,
                id,
            }
        }

        const toggleTodoAction = (id) => {
            return {
                type: TOGGLE_TODO,
                id,
            }
        }

        const addGoalAction = (goal) => {
            return {
                type: ADD_GOAL,
                goal,
            }
        }

        const removeGoalAction = (id) => {
            return {
                type: REMOVE_GOAL,
                id,
            }
        }

        // Reducer function
        const todos = (state = [], action) => {
            switch(action.type) {
                case ADD_TODO:
                    return state.concat([action.todo])
                case REMOVE_TODO:
                    return state.filter(todo => todo.id !== action.id)
                case TOGGLE_TODO:
                    return state.map(todo => todo.id !== action.id ? todo : {...todo, complete: !todo.complete})
                default:
                    return state
            }
        }

        const goals = (state = [], action) => {
            switch(action.type) {
                case ADD_GOAL:
                    return state.concat([action.goal])
                case REMOVE_GOAL:
                    return state.filter(goal => goal.id !== action.id)
                default:
                    return state
            }
        }

        const app = (state = {}, action) => {
            return {
                todos: todos(state.todos, action),
                goals: goals(state.goals, action),
            }
        }

        // For testing purpose
        const store = createStore(app)

        store.subscribe(() => {
            console.log("The new state is: ", store.getState())
        })

        store.dispatch(addTodoAction({
            id: 1,
            name: "Walk the dog",
            complete: false,
        }))

        store.dispatch(addTodoAction({
            id: 2,
            name: "Wash the motorbike",
            complete: false,
        }))

        store.dispatch(addTodoAction({
            id: 3,
            name: "Go to the gym",
            complete: true,
        }))

        store.dispatch(removeTodoAction(1))

        store.dispatch(toggleTodoAction(2))

        store.dispatch(addGoalAction({
            id: 1,
            name: "Learn Redux",
        }))

        store.dispatch(addGoalAction({
            id: 2,
            name: "Lose 20 pounds",
        }))

        store.dispatch(removeGoalAction(2))
    </script>
</body>
</html>